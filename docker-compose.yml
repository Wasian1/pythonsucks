services:
  # Image file name
  pythonsucks-discordbot:
    build: .
    container_name: pythonsucksbot

    # Inject secrets at runtime (not baked into the image)
    env_file: settings.env

    # Restart policy: keep the bot alive across crashes and reboots
    restart: always

    # Mount DATA ONLY so CSV updates don't require rebuilds.
    # On the host (Pi), ./data maps to /botapp/data inside the container.
    volumes:
      - .:/botapp:rw

    
    # Lavalink dependency
    depends_on:
      - lavalink

  
  lavalink:
    image: ghcr.io/lavalink-devs/lavalink:4
    container_name: lavalink
    restart: always
    ports:
      - "2333:2333" # expose if external needed
    env_file:
      - settings.env
    volumes:
      - ./lavalink/application.yml:/opt/Lavalink/application.yml

    entrypoint: ["java"]
    command: ["-Xms128M", "-Xmx512M", "-Duser.language=en", "-Duser.country=US", "-jar", "Lavalink.jar"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H 'Authorization: ${LAVALINK_PASSWORD}' http://localhost:2333/version || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Optional healthcheck to ensure the container is "healthy"
    # (uncomment and adapt to your bot if you expose a health endpoint or add a small script)
    # healthcheck:
    #   test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('discord.com', 443)); s.close()"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 5